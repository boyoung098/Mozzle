<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mozzle.web.Schedule">

	<!-- 일정리스트 -->
	<select id="scheduleselectAll" parameterType="java.util.Map"
		resultType="ScheduleDto">
		SELECT s.SCHEDULE_ID
		,s.MOZZLE_ID ,s.WRITER ,s.TITLE
		,s.CONTENT ,s.SCHEDULE_DATE ,s.REGDATE
		,si.LOCATION_NAME, si.ADDRESS,
		si.ADDRESS2, si.PHONE
		FROM SCHEDULES s
		INNER JOIN SCHEDULE_INFO si
		ON
		S.LOCATION_CODE = si.LOCATION_CODE
		WHERE MOZZLE_ID = #{mozzle_id} AND
		SUBSTR(SCHEDULE_DATE,1,8) = #{yyyyMMdd}
		ORDER BY SCHEDULE_DATE
	</select>

	<!-- 일정추가 -->
	<insert id="scheduleinsert" parameterType="ScheduleDto">
		INSERT INTO
		SCHEDULE_INFO
		(LOCATION_CODE ,LOCATION_NAME ,ADDRESS ,ADDRESS2 ,PHONE
		,LOGUI ,LAT)
		VALUES(SCHEDULE_INFO_SEQ.NEXTVAL,#{location_name},#{address},#{address2},#{phone},#{logui},#{lat});

		INSERT INTO SCHEDULES
		(SCHEDULE_ID, MOZZLE_ID, WRITER, TITLE, CONTENT,
		SCHEDULE_DATE, REGDATE, DELFLAG,
		LOCATION_CODE)
		VALUES(SCHEDULE_SEQ.NEXTVAL, #{mozzle_id} , #{writer}, #{title},
		#{content}, #{schedule_date}, SYSDATE, 'N',
		#{location_code})
	</insert>

	<!-- 일정 상세보기 -->
	<select id="scheduleselectOne" parameterType="Integer"
		resultType="ScheduleDto">
		SELECT s.SCHEDULE_ID ,s.MOZZLE_ID ,s.WRITER ,s.TITLE
		,s.CONTENT ,s.SCHEDULE_DATE ,s.REGDATE ,si.LOCATION_NAME, si.ADDRESS,
		si.ADDRESS2, si.PHONE
		FROM SCHEDULES s
		INNER JOIN SCHEDULE_INFO si
		ON
		S.LOCATION_CODE = si.LOCATION_CODE
		WHERE SCHEDULE_ID = #{schedule_id}
	</select>

	<!-- 일정 변경 -->
	<update id="scheduleupdate" parameterType="ScheduleDto">
		UPDATE SCHEDULES
		SET
		TITLE='변경된TITLE',CONTENT='변경된CONTENT',SCHEDULE_DATE='202112191207',REGDATE
		=SYSDATE
		WHERE SCHEDULE_ID = #{schedule_id}
	</update>
	
	<!-- 일정삭제(delete) -->
	<delete id="scheduledelete" parameterType="java.util.Map">
		DELETE FROM SCHEDULES WHERE SCHEDULE_ID IN
		<foreach collection="schedule_ids" item="schedule_id" open="(" close=")" separator=",">
			#{schedule_id}
		</foreach>
	</delete>

	<!-- 일정개수 -->
	<select id="schedulecount" parameterType="java.util.Map" resultType="Integer">
		SELECT NVL(COUNT(*),0)
		FROM SCHEDULES
		WHERE SCHEDULE_DATE = #{schedule_date}
	</select>









	<!-- 일정리스트(개수보여주기) -->
	<select id="scheduleselectViewAll" parameterType="java.util.Map">
		SELECT
		SCHEDULE_ID, WRITER, TITLE, CONTENT,
		SCHEDULE_DATE,REGDATE,LOCATION_CODE
		FROM(SELECT ROW_NUMBER()
		OVER(PARTITION BY SUBSTR(SCHEDULE_DATE,1,8) ORDER BY
		SCHEDULE_DATE) RN,
		SCHEDULE_ID, WRITER, TITLE, CONTENT,
		SCHEDULE_DATE,REGDATE,LOCATION_CODE
		FROM SCHEDULES s
		WHERE SCHEDULE_DATE
		= #{schedule_date})
		WHERE RN BETWEEN 1 AND 3;
	</select>





	


</mapper>